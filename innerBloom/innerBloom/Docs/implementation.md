# iOS App Requirements Document —「陪伴日記 Dairy」

> 用 Swift + SwiftUI + Xcode 做一個簡單日記 App：使用者快速記錄照片/影片（可選文字/語音），讓 先理解內容再用溫暖的方式陪你聊聊；每次聊天結束後，自動整理成「像使用者口吻」的日記頁（含媒體＋文字總結＋標籤），之後可用「標籤圖塊」分類與回顧。  
> **資料庫選用：Supabase（Postgres + Storage）**，用來支援快速開發上線與跨裝置同步。  
> **大模型選用：ChatGPT**，由後台配置可切換其他大模型（App 不用改版即可換）。

---

## 1) App Overview

這是一個給想要「快速記錄生活、又想有人陪聊」的使用者的日記 App。使用者只要選一張照片或一段影片（可加一句話或用語音說），「InnerBloom 夥伴」就會先理解內容，接著用連續對話的方式陪伴聊天。每次對話結束後，App 會把對話精華整理成一篇「像使用者自己寫的」日記，並把原本的照片/影片一起保存，**同時生成一組標籤**（例如：旅行/朋友/焦慮/開心）。主頁可用「標籤圖塊」快速選取要回憶的分類，方便翻找。  
為了支援「快速上線、登入與跨裝置同步、媒體儲存、資料查詢與搜尋」，後端資料儲存選用 **Supabase**：文字與結構化資料存 DB、照片/影片存 Storage。  
為了支援「成本/效果/合規」上的彈性，AI 服務支援 **大模型供後台切換，前期使用ChatGPT**。

---

## 2) Main Goals

1. 讓使用者用最少步驟新增一篇「媒體日記」。
2. 在同一頁完成「上傳媒體 + 輸入（語音/文字）+ AI 陪聊」，聊天是連續的（不會每次都像重新開始）。
3. 每次結束保存後，自動生成一篇「使用者口吻」的日記總結，**並附上標籤**，存到日記列表。
4. 使用者可以用「標籤圖塊」分類回憶，快速回頭瀏覽、搜尋、查看過去的日記頁。
5. App 使用起來簡單、穩定，離線時也不會壞掉（至少能先存草稿或提示稍後再試）。
6. 能快速開發上線，並支援後續跨裝置同步與帳號登入（由 Supabase 提供）。
7. AI 供應商可由後台切換（前期使用ChatGPT），不用重新上架 App。

---

## 3) User Stories

- **US-001**：作為使用者，我想要快速選擇一張照片或影片並儲存，這樣我可以不用打很多字也能記錄生活。  
- **US-002**：作為使用者，我想要（可選）加上一句簡短文字，這樣 AI 更懂我當下想表達什麼。  
- **US-003**：作為使用者，我想要用語音輸入我的想法，這樣我更省力、更自然。  
- **US-004**：作為使用者，我想要 AI 看完照片/影片後在同一頁跟我聊，這樣流程不會被切斷。  
- **US-005**：作為使用者，我想要聊天是連續的，這樣我隔天接著聊也不會斷掉情緒。  
- **US-006**：作為使用者，我想要每次聊完「結束保存」就自動產生日記總結，這樣我不用自己整理。  
- **US-007**：作為使用者，我想要總結時自動帶上標籤，這樣我回頭找回憶更快。  
- **US-008**：作為使用者，我想要用標籤圖塊選取要回憶的分類，這樣我能按主題翻日記。  
- **US-009**：作為使用者，我想要搜尋以前的日記（例如用關鍵字或日期），這樣我能快速找到那篇。  
- **US-010**：作為使用者，我想要在網路不穩時也能先保存，這樣我不會因為失敗而失去記錄。  
- **US-011**：作為使用者，我想在主頁由右往左滑就能快速新增日記，這樣我記錄更順手。  
- **US-012**：作為使用者，我想要登入後在不同裝置看到同一份日記回憶庫，這樣我換手機也不會丟資料。  
- **US-013**：作為產品/營運，我想在後台選擇用「ChatGPT」，保留大模型切換的配置，這樣我可以依成本/效果隨時切換。  

---

## 4) Features

### 新增與輸入

- **F-001：新增日記（選照片/影片）**
  - **做什麼**：讓使用者從相簿選擇 1 個照片或 1 個影片，建立一篇新的日記「草稿」。
  - **何時出現**：主頁「右→左滑」或「＋」按鈕（備援）。
  - **出錯怎麼辦**：  
    - 沒選到媒體：提示「請先選擇照片或影片」。  
    - 影片太大或讀取失敗：提示「影片讀取失敗，請換一段或稍後再試」。

- **F-002：文字輸入（可選）**
  - **做什麼**：輸入一小段文字（例如心情、發生什麼事）。
  - **何時出現**：在主頁同頁操作（見 S-001），媒體下方顯示文字框。
  - **出錯怎麼辦**：文字太長就提示「文字太長，請簡短一點」（並限制字數）。

- **F-011：語音輸入**
  - **做什麼**：按一下麥克風開始說話，把語音轉成文字，放進輸入框（可再編輯）。
  - **何時出現**：媒體下方、文字框附近（見 S-001）。
  - **出錯怎麼辦**：  
    - 沒授權麥克風：提示「需要麥克風權限才能語音輸入」並引導去設定。  
    - 辨識失敗：提示「聽不清楚，請再試一次」。

### AI 理解與陪聊

- **F-003：AI 分析照片/影片內容**
  - **做什麼**：把媒體內容交給 AI 產生「它看到了什麼」的理解，用來當聊天背景。
  - **何時出現**：選完媒體後，自動或在第一次送出訊息前觸發（二選一，第一版建議：第一次送出才觸發）。
  - **出錯怎麼辦**：  
    - 沒網路/失敗：提示「目前無法分析，已先保存草稿，稍後可再試」。  
    - AI 回來的內容怪怪的：提供「重新分析」按鈕。

- **F-004：連續聊天（同一篇日記內）**
  - **做什麼**：在同一篇日記裡跟 AI 來回聊天，夥伴回覆要承接前文。
  - **何時出現**：同頁面中，在媒體區正中間顯示聊天訊息（見 S-001）。
  - **出錯怎麼辦**：  
    - 發送失敗：顯示「傳送失敗，點一下重試」。  
    - AI 太久沒回：顯示「正在等回覆…」並可取消。

- **F-005：結束保存（生成總結 + 生成標籤）**
  - **做什麼**：使用者按「結束保存」後：
    1) AI 把這次聊天整理成一篇日記（用使用者口吻）  
    2) **同時產生 3~8 個標籤**（例如：旅行/朋友/焦慮/開心）  
    3) 把媒體 + 總結 + 標籤一起存檔（本機草稿可保留作為備援）
  - **何時出現**：同頁面底部，與「取消」並列。
  - **出錯怎麼辦**：  
    - 生成失敗：提示「總結/標籤生成失敗，但聊天已保存。可稍後再生成。」並提供「再試一次」。  
    - 存檔失敗：提示「保存失敗，請稍後再試」，並保留草稿不丟失。

### 日記回顧與搜尋（標籤化回憶）

- **F-006：日記列表（時間排序，並跟標籤分類連動）**
  - **做什麼**：顯示日記（縮圖＋日期＋一句摘要），內容會依「目前選取的標籤分類」切換。
  - **何時出現**：主頁列表區。
  - **出錯怎麼辦**：  
    - 列表讀不到資料：顯示空狀態「目前還沒有日記」。  
    - 該標籤沒有日記：顯示空狀態「這個分類還沒有日記」。

- **F-007：日記詳情頁（媒體＋日記總結＋標籤＋聊天紀錄）**
  - **做什麼**：打開某篇日記後可看照片/影片、AI 生成的日記內容、**標籤**，也可查看聊天訊息。
  - **何時出現**：點主頁列表的某一篇。
  - **出錯怎麼辦**：媒體載入失敗：顯示「媒體無法播放」，但仍顯示文字內容。

- **F-008：搜尋與篩選（與標籤一起工作）**
  - **做什麼**：用關鍵字搜尋日記內容（例如總結文字、使用者輸入）。
  - **何時出現**：主頁上方搜尋框（若你要保留）。
  - **規則**：  
    - 若目前選的是某個標籤：只搜尋該標籤內的日記  
    - 若目前選的是「全部」：搜尋所有日記
  - **出錯怎麼辦**：沒有結果：顯示「找不到符合的日記」。

### 主頁回憶分類與手勢（標籤圖塊）

- **F-009：標籤圖塊選取回憶分類（主頁核心）**
  - **做什麼**：主頁上方顯示一組「標籤圖塊」（chips/tiles），點選後切換回憶分類。
  - **何時出現**：主頁一進來就看到（至少顯示：全部 + 最近常用標籤）。
  - **出錯怎麼辦**：  
    - 沒有任何標籤：只顯示「全部」  
    - 點了標籤但沒內容：顯示空狀態「這個分類還沒有日記」

- **F-010：主頁右→左滑快速新增**
  - **做什麼**：使用者在主頁往右→左滑，進入「新增/聊天同頁」開始建立新日記。
  - **何時出現**：只在主頁生效。
  - **出錯怎麼辦**：  
    - 使用者誤觸：可按「取消」回主頁，不產生垃圾資料  
    - （可選）第一次使用時顯示小提示：例如「左滑可新增日記」

### 後端與同步（Supabase）

- **F-012：Supabase 同步保存**
  - **做什麼**：把日記、聊天訊息、標籤存到 Supabase（DB），照片/影片上傳到 Supabase Storage。
  - **何時出現**：  
    - 建立草稿時：可先只存本機（快速）  
    - 按「結束保存」時：一定要把完整資料上傳/同步到 Supabase（主路徑）
  - **出錯怎麼辦**：  
    - 上傳/同步失敗：提示「雲端同步失敗，已保留在本機，稍後會再試」  
    - 重試方式：回到網路正常時，App 背後自動重試（第一版可做成手動「再試一次」按鈕）

- **F-013：登入（可選，後續）**
  - **做什麼**：使用者登入後，把資料綁到自己的帳號，換手機也能同步。
  - **何時出現**：第一版可不做；第二階段加到設定頁或首次啟動。
  - **出錯怎麼辦**：登入失敗提示原因與重試。


### 帳號與多用戶（10萬用戶目標）

- **F-017：登入 / 註冊 / 登出（正式上線必備）**
  - **做什麼**：讓使用者用自己的帳號登入 App（建議：Email + 一次性驗證碼，或 Email+密碼；也可後續加 Apple 登入）。
  - **何時出現**：  
    - 第一次開啟 App：若未登入，先顯示登入頁（S-004）。  
    - 已登入：直接進主頁（S-001）。
  - **出錯怎麼辦**：  
    - 驗證碼錯誤/過期：提示「驗證碼不正確或已過期」並可重新發送。  
    - 網路不穩：提示「目前無法登入，請稍後再試」。

- **F-018：資料隔離（每個帳號只看到自己的資料）**
  - **做什麼**：同一套 Supabase DB 服務 10 萬用戶，但每個人只看得到自己的日記、聊天、標籤與媒體。
  - **如何做到（用白話講）**：
    1. 每筆資料都帶一個「這筆資料屬於誰」的欄位（例如 `user_id`）。
    2. 後端（Supabase）設定規則：**只有登入者本人**能讀/寫 `user_id = 自己` 的資料（這組規則叫「資料保護規則」）。
    3. 媒體檔案路徑也要分開：例如 `userId/diaryId/file.jpg`，避免互相看到。
  - **何時出現**：所有讀寫 Supabase 的地方（F-012、列表、詳情、搜尋、標籤）都必須自動帶入當前登入者。
  - **出錯怎麼辦**：  
    - 權限不足（被擋下）：顯示「沒有權限」並引導重新登入。  
    - `user_id` 缺失或錯誤：直接視為資料異常，停止上傳並提示「資料狀態異常，請重試」。

- **F-019：使用者設定雲端同步（可選，但建議）**
  - **做什麼**：把使用者設定（口吻、語言、隱私開關等）也跟帳號綁定，換手機仍保留。
  - **何時出現**：登入後讀一次；使用者改設定就同步更新。
  - **出錯怎麼辦**：雲端失敗就先用本機設定，並提示「設定同步失敗，稍後再試」。


### 模型供應商切換

- **F-014：模型供應商後台配置**
  - **做什麼**：後台（可存在 Supabase）保存「目前使用的模型供應商」設定：  
    - 選項：**ChatGPT**
  - **何時出現**：App 啟動或進入聊天時讀取一次（並快取），後續依設定呼叫對應模型。
  - **出錯怎麼辦**：  
    - 讀取設定失敗：預設使用一個安全的預設值（例如：ChatGPT），並提示「設定讀取失敗，已使用預設模型」。

- **F-015：統一 AI 呼叫入口**
  - **做什麼**：
        1) **App 永遠只呼叫「同一個你自己的後端網址」**（不管是看圖、聊天、總結、標籤，都走同一個入口）。  
        2) **App 不直接連ChatGPT**，也**不在 App 內放任何模型金鑰**。    
        3) **後端依「後台設定」決定要用 ChatGPT 或 其他模型**，必要時可以做「自動備援切換」。  
        4) **後端會把不同模型的回覆格式統一**，讓 App 永遠用同一種方式解析結果。 
    - 好處：App 不暴露任何金鑰、供應商切換不需要發版。
  - **何時出現**：所有 陪伴功能（分析、聊天、總結、標籤）都走同一入口。
  - **出錯怎麼辦**：  
    - 供應商 A 失敗：可在後端選擇「自動切到另一個」或回傳清楚錯誤讓 App 顯示重試（第一版先做手動重試即可）。

- **F-016：環境感知（天氣/時間/地點）**
  - **做什麼**：
    1. **固定歡迎語**：用戶剛進入新增模式時，顯示固定的歡迎語（不調用 AI）。
    2. **環境問候**：用戶上傳照片後，App 抓取當前定位的天氣與時間，AI 結合照片內容＋環境資訊給出第一句問候（例如：「下雨的傍晚，這張照片看起來好寧靜...」）。
    3. **連續對話增強**：後續對話中，AI 始終知道當下的天氣與時間，讓對話更貼近真實情境。
  - **何時出現**：新增日記流程中。
  - **出錯怎麼辦**：
    - 沒權限/獲取失敗：使用預設通用問候，不提及
### 付費（Premium 訂閱）與用量限制

> **注意：App 介面文案避免出現「AI」兩個字**。對使用者改用「InnerBloom 夥伴 / 陪伴小幫手 / 陪伴回覆」等溫暖說法；技術文件內仍可用「AI」指代後端能力。

- **F-020：免費用量限制（聊天互動 + 每日總結）**
  - **做什麼**：未訂閱時，限制「陪伴互動」的使用量，避免成本失控。
    - 每篇日記：**最多 4 次互動**（使用者送出一次 + 夥伴回覆一次算 1 次互動回合，或依你現有定義；請固定一種算法）
    - 每日：**最多 1 次日記總結**（按「結束保存」觸發）
  - **何時出現**：  
    - 送出訊息前（F-004）檢查互動次數  
    - 按「結束保存」前（F-005）檢查今日總結次數
  - **出錯怎麼辦**：  
    - 計數讀不到：先當作已用完（保守），提示「目前無法確認用量，請稍後再試」並提供「同步/重試」。

- **F-021：Premium 訂閱方案（Apple IAP 自動續訂）**
  - **做什麼**：提供月付 / 年付（年付折扣），並支援 **3 天試用**（Premium 試用）。
  - **何時出現**：  
    - 設定頁入口「升級 Premium」  
    - 或用量用完時（S-006 → S-005）
  - **出錯怎麼辦**：產品列表讀不到或購買失敗時，提示原因與「重試 / 稍後再試」。

- **F-022：訂閱狀態同步（是否為 Premium）**
  - **做什麼**：App 啟動、回前台、完成購買後，都要刷新一次 Premium 狀態（含試用/續訂）。
  - **何時出現**：啟動、回前台、購買流程完成時。
  - **出錯怎麼辦**：狀態不確定時，UI 顯示「正在同步…」，同步完再更新；同步失敗就先用本機快取狀態並提示。

- **F-023：恢復購買（Restore Purchases）**
  - **做什麼**：換手機或重裝後，讓使用者一鍵恢復 Premium。
  - **何時出現**：付費牆（S-005）內。
  - **出錯怎麼辦**：恢復失敗要提示原因（未購買/網路問題/稍後再試）。

- **F-024：Premium 優先佇列（更快回覆）**
  - **做什麼**：Premium 的所有「陪伴請求」（分析/聊天/總結/標籤）都加上 `isPremium=true`，後端以較高優先級處理，讓回覆更快。
  - **何時出現**：每次呼叫後端時自動帶入。
  - **出錯怎麼辦**：後端不支援優先時，直接退化成一般速度，不影響功能。

### Premium 專屬：陪伴角色（口吻風格，方案 1 + A）

- **F-025：陪伴角色選擇（Premium 才能切換）**
  - **做什麼**：把原本「口吻風格」做成「身邊的角色」，用 **角色卡片清單** 讓使用者像在選一個陪伴者。
  - **角色（內建 4 個）**：
    1. **阿暖｜貼心好友**：溫暖治癒、先安撫再給小建議  
    2. **阿衡｜理性同事**：極簡客觀、條列重點、少情緒  
    3. **阿樂｜幽默搭子**：輕鬆有趣、但不冒犯  
    4. **阿澄｜懂你的人**：共情理解、擅長提問與陪你梳理  
  - **何時出現**：設定頁（S-003）「陪伴角色」點進去 → S-007（Bottom Sheet/卡片清單）。
  - **非 Premium 怎麼辦**：  
    - 看到角色清單但不可切換（灰階 + 鎖頭），點選任一角色 → 直接去付費牆（S-005）。  
    - Premium：可自由切換並立即生效。
  - **出錯怎麼辦**：角色設定讀不到就使用預設角色（例如阿暖）並提示「已先使用預設陪伴角色」。

- **F-026：聊天與總結都要跟隨角色**
  - **做什麼**：使用者選的角色要同時影響：
    - F-004 連續聊天的回覆口吻  
    - F-005「結束保存」生成總結的文字風格（同一個角色，讓整篇更一致）
  - **規則**：
    - 角色切換後，只影響「之後」的新回覆與新總結  
    - 已生成的歷史日記內容不強制重寫（避免改動既有資料）


---

天氣。

---

## 5) Screens

- **S-001：主頁 + 新增/聊天同頁**
  - **核心想法**：在同一頁完成「回憶分類選取 + 列表回顧 + 新增媒體 + 文字/語音輸入 + 陪伴對話 + 結束保存」  
  - **畫面內容（由上到下）**：
    1. **標籤圖塊區（回憶分類）**：點圖塊切換分類（F-009)
    2. **日記列表（直向）**：顯示目前標籤分類下的日記（F-006）
    3. **頁面正中間：媒體區（照片/影片）**
       - 新增模式：顯示媒體預覽（若還沒選媒體，顯示「選擇照片/影片」引導）
    4. **媒體下方：語音輸入按鈕 + 文字輸入框**
       - 語音按鈕：一鍵說話轉文字（F-011）
       - 文字框：可輸入/可編輯
    5. **再往下：兩個並列按鈕**
       - 左：**取消**
       - 右：**結束保存**（F-005），並觸發雲端同步（F-012）
    6. **（输入对话时）**：在媒體區正中间顯示聊天訊息（F-004）

  - **怎麼來**：App 開啟即進入。
  - **可去**：  
    - 右→左滑（F-010）→ 仍在本頁，但切換成「新增/聊天模式」  
    - 點某篇日記 → S-002  
    - 點標籤圖塊 → 仍在本頁（切換列表內容）

- **S-002：日記詳情（媒體 + 日記總結 + 標籤 + 聊天紀錄）**
  - **畫面內容**：  
    - 照片/影片播放器  
    - **標籤區（圖塊）**：顯示這篇日記的標籤，可點一下跳回主頁並套用該標籤分類
    - 日記總結全文  
    - （可折疊）聊天紀錄
    - 有月历点击直接转跳到日期
  - **怎麼來**：從主頁列表點某篇日記。
  - **可去**：返回 → S-001。

- **S-003：設定（可選，第一版可先不做）**
  - **畫面內容**：陪伴口吻偏好、是否自動生成標題、隱私說明、（未來）語言選擇、（未來）登入/登出。  
  - **（可選給內部使用）**：顯示目前使用的模型供應商（只讀），真正切換在後台做。
  - **怎麼來**：主頁右上角齒輪。
  - **可去**：返回主頁。

---


- **S-004：登入 / 註冊（正式上線必備）**
  - **畫面內容**：
    - App Logo + 簡短隱私提示（「資料會與帳號綁定並同步」）
    - Email 輸入
    - 「送出驗證碼」按鈕（或 Email+密碼登入）
    - 驗證碼輸入 + 「登入」按鈕
    - （可選）「使用 Apple 登入」
  - **怎麼來**：首次啟動且未登入；或使用者在設定頁按「登出」後返回。
  - **可去**：
    - 登入成功 → S-001 主頁
    - 登入失敗 → 留在本頁顯示原因與重試



- **S-005：Premium 升級（付費牆）**
  - **畫面內容**：
    - Premium 權益（解除限制 / 優先回覆 / 陪伴角色可切換）
    - 月付 / 年付（顯示年付折扣）+ **3 天試用**說明
    - 主要購買按鈕
    - 「恢復購買」按鈕
    - 條款/隱私/取消訂閱說明
  - **怎麼來**：  
    - 設定頁「升級 Premium」  
    - 或 S-006 引導進來
  - **可去**：購買成功 → 返回原頁並立即解鎖權益；取消 → 返回。

- **S-006：用量已用完（升級提示）**
  - **畫面內容**：
    - 溫暖提示文案（避免用「AI」字眼）：例如「今天的陪伴次數用完了，升級 Premium 可不限次」
    - 「升級 Premium」主要按鈕（進 S-005）
    - （可選）「明天再說」回到原頁
  - **怎麼來**：超過免費上限時（F-020）。
  - **可去**：S-005 或返回原頁。

- **S-007：陪伴角色選擇（卡片清單 Bottom Sheet）**
  - **畫面內容（每張卡）**：
    - 角色小圖示（抽象符號風格 A）
    - 角色名 + 身份標籤（如「貼心好友」）
    - 1 句個性描述
    - 1 句「示例回覆」
    - 已選中顯示打勾；非 Premium 顯示鎖頭與灰階
  - **怎麼來**：設定頁（S-003）點「陪伴角色」。
  - **可去**：選中角色 → 關閉 Sheet 回設定頁；非 Premium 點選 → S-005。


## 6) Data

- **D-001：日記清單**  
  每篇日記的：id、日期時間、縮圖、媒體類型（照片/影片）、媒體檔案位置（雲端路徑/本機路徑）。

- **D-002：使用者輸入內容（文字/語音轉文字）**  
  使用者輸入的一段短文字。

- **D-003：聊天訊息**  
  每則訊息的：誰說的（使用者/AI）、內容、時間。

- **D-004：AI 分析結果**  
  AI 對照片/影片「看到了什麼」的文字描述。

- **D-005：日記總結（使用者口吻）**  
  每次「結束保存」產生的文章內容。

- **D-006：狀態**  
  是否已分析、是否已生成總結、是否保存完成、是否已雲端同步、最後一次錯誤訊息。

- **D-007：設定（可選）**  
  陪伴口吻、深色模式、（未來）語言設定、（未來）登入狀態。

- **D-008：標籤清單**  
  標籤 id、名稱、排序、（可選）顏色/圖示、是否系統預設。

- **D-009：日記的標籤**  
  每篇日記對應的標籤列表。

- **D-010：Supabase 對應資料**
  - 日記/聊天/標籤：Supabase DB  
  - 照片/影片：Supabase Storage  
  - 記錄雲端 id 與本機暫存狀態

- **D-011：模型供應商設定**
  - 內容：目前使用哪個模型（ChatGPT）
  - 存放位置：可存在 Supabase（例如一張設定表或一筆設定記錄）

- **D-012：環境資訊 (Context)**
  - 經緯度 (Location)、天氣狀況 (Weather Description)、當地時間 (Local Time)。
  - 用於發送給 AI 作為 System Prompt 的一部分。

---


- **D-013：登入狀態（Session）**
  - 目前是否已登入、登入者的 `user_id`、token 是否有效（讓 App 知道要不要顯示 S-004）。

- **D-014：使用者資料（Profile）**
  - 使用者暱稱（可選）、建立時間、偏好語言（可選）。
  - 與 Supabase Auth 的 `user_id` 一對一綁定。

- **D-015：多用戶資料欄位（重要）**
  - 日記、聊天、標籤、關聯表都需要有 `user_id` 欄位，用來標記「屬於誰」。
  - 所有查詢都必須自動帶 `user_id = 當前登入者`，避免不同帳號互相看到資料。

- **D-016：Storage 路徑規則（重要）**
  - 例如：`{user_id}/{diary_id}/{filename}`，確保媒體檔案天然分隔。



- **D-017：Premium 訂閱狀態**
  - 是否 Premium、是否在試用期、到期時間（若可取得）、最後同步時間。

- **D-018：免費用量計數**
  - 每篇日記已互動次數（用於「每篇最多 4 次互動」）
  - 今日已生成總結次數（用於「每日 1 次總結」）
  - 需要支援跨日自動重置（依本機日期）。

- **D-019：IAP 產品資訊快取**
  - 月付/年付價格、試用文案、顯示用的方案描述（供 S-005 使用）。

- **D-020：優先佇列標記**
  - `isPremium`：每次送出「陪伴請求」時帶給後端。

- **D-021：陪伴角色選擇**
  - `companion_role_id`（例如：warm / clear / fun / empath）
  - 角色屬於使用者設定的一部分，建議跟隨 F-019 同步到雲端。

- **D-022：角色定義（內建）**
  - 每個角色：id、名稱、描述、示例回覆、對應提示詞規則（用於生成回覆與總結）。


## 7) Extra Details

1. **需要網路嗎？**  
   - AI 分析與聊天需要網路。  
   - 沒網路時，至少能先建立日記草稿，待網路恢復再同步到 Supabase。

2. **資料存哪裡？（Supabase）**  
   - 結構化資料（日記/聊天/標籤）→ Supabase DB  
   - 照片/影片檔案 → Supabase Storage  
   - 本機：離線草稿與同步失敗暫存

3. **需要哪些 iPhone 權限？**  
   - 相簿、麥克風（語音輸入）、（可選）相機。

4. **深色模式？**  
   - 跟隨系統。

5. **隱私提示**  
   - 媒體與文字/語音可能送去 AI 服務。  
   - 資料會同步到雲端（Supabase）。

6. **後續擴展：多語言**  
   - UI 文案可切換；AI 輸出語言跟隨使用者選擇。

7. **模型切換策略**
   - App 端不直接接豆包/ChatGPT；一律呼叫你自己的後端入口（更安全、可切換）。
   - 後台可隨時切換目前供應商：豆包 或 ChatGPT。


8. **介面文案不出現「AI」**
   - 對使用者的稱呼：用「InnerBloom 夥伴 / 陪伴小幫手 / 陪伴回覆」等溫暖描述。
   - 設定頁用詞：把「AI 口吻/AI 設定」改成「陪伴口吻/陪伴設定」。


---

## 8) Build Steps

- [x] **B-001**：先做主頁骨架（S-001）  
  - 標籤圖塊 + 列表空狀態 + 媒體區 + 輸入區 + 取消/結束保存

- [x] **B-002**：新增/聊天模式切換（F-010）  
  - 右→左滑進新增；取消回瀏覽

- [x] **B-003**：選媒體與本機草稿保存（F-001 + D-001/D-002）

- [x] **B-004**：接入 Supabase（連線與 Storage）  
  - 媒體可上傳到 Storage，拿到雲端路徑

- [x] **B-005**：日記資料存進 Supabase DB（F-012）  
  - 建立最小資料表（見 D-010）

- [x] **B-006**：加入語音輸入（F-011）

- [x] **B-007**：加入聊天訊息區（先假資料）  
  - F-004 UI + D-003 本機存訊息

- [x] **B-008**：接 AI 分析（F-003）

- [x] **B-009**：接 AI 連續聊天（F-004 真正接通）【更新：支援ChatGPT 或 其他模型 後台切換】  
  - App 端改成呼叫「統一 AI 後端接口」（F-015）  
  - 後端依 **D-011 模型供應商設定** 決定用：  
    - **ChatGPT**：用 ChatGPT 的聊天/多模態能力處理（看圖/聊天/總結/標籤）
  - 對話仍承接同一篇日記的背景（D-004）與歷史訊息（D-003）  
  - 同步策略：第一版可在「結束保存」一次性把訊息寫入 Supabase；後續再做即時同步

- [x] **B-010**：環境感知整合（F-016 + D-012）
  - 實作 LocationManager 與 WeatherService
  - 更新 AI Service：支援傳入環境 Context
  - 更新聊天流程：
    1. 進入時顯示固定歡迎語
    2. 上傳媒體觸發天氣獲取 -> AI 問候
    3. 對話持續攜帶媒体及環境參數

- [x] **B-011**：實作「結束保存」（F-005）＋ 標籤落庫（Supabase）

- [x] **B-012**：日記詳情頁（S-002）  
  - 含標籤顯示與月曆跳轉

- [x] **B-013**：主頁標籤圖塊與列表讀 Supabase  
  - 依標籤切換讀取日記列表
  - 日記加載時自動獲取 tagIds
  - 標籤列表確保「全部」始終首位
  - 支援下拉刷新

- [x] **B-014**：主頁搜尋（F-008）
  - 搜索框 UI（標題欄下方）
  - 支援搜索標題、總結、用戶輸入
  - 搜索範圍跟隨當前標籤
  - 搜索結果提示與清除功能

- [x] **B-015**：補齊同步失敗體驗（F-012）
  - 失敗條目顯示重試按鈕
  - 同步失敗 Banner 提示
  - 支援單條重試和批量重試

- [x] **B-016**：設定頁面與用戶自定義（S-003 + D-007）
  - 創建 UserSettings 模型（外觀模式、陪伴口吻、語言、隱私設定等）
  - 創建 SettingsManager 管理本地存儲
  - 創建 SettingsView 設定頁面 UI
    - 外觀設定：跟隨系統/深色/淺色模式切換
    - 陪伴設定：口吻風格選擇（溫暖治愈/極簡客觀/幽默風趣/共情理解）
    - 陪伴設定：自動生成標題/標籤開關
    - 語言設定：預留多語言支援（簡中/繁中/英文/日文）
    - 隱私設定：媒體分析/位置分享開關
    - 隱私政策頁面
    - 關於：版本信息、重置設定
    - 開發者：顯示模型供應商（只讀）
  - 更新 ContentView 添加設定入口（右上角齒輪圖標）
  - 更新 Theme 預留淺色模式顏色配置
  - **移除新增頁面的風格選擇器**，統一在設定頁面選擇
  - AIService 根據用戶設定自動調整提示詞
  - 添加調試日誌打印完整系統提示詞（後台可見）

- [x] **B-017**：多語言功能實現（繁體中文/English）
  - 創建 LocalizationManager 多語言管理器
    - 使用 @Observable 實現響應式語言切換
    - 支援即時語言切換，無需重啟 App
    - 通過 languageChangeId 觸發視圖刷新
  - 創建 L10nKey 枚舉集中管理所有可本地化字符串
    - 通用文案（確定、取消、刪除、重試等）
    - 主頁文案（搜索、列表空狀態、同步失敗提示）
    - 設定頁面文案（陪伴設定、隱私設定、關於等）
    - 陪伴口吻風格名稱和描述
    - 隱私政策內容
    - 新增日誌頁面文案（輸入區、聊天覆蓋層、操作按鈕）
  - 更新 UserSettings 和 SettingsManager
    - setAppLanguage 同步通知 LocalizationManager
    - 重置設定後同步語言狀態
  - 更新所有主要視圖使用本地化字符串
    - ContentView：錯誤提示、搜索框、同步失敗 Banner
    - DiaryListView：載入中、空狀態、處理狀態
    - DiaryDetailView：標籤、對話回顧、刪除操作
    - ChatView：回覆輸入框
    - SettingsView：所有設定項和隱私政策
    - **InputAreaView**：語音輸入提示、心情輸入框占位符、無障礙標籤
    - **ChatOverlayView**：建議話題提示、更多訊息提示
    - **ActionButtonsView**：儲存回憶按鈕
  - 語言選項：
    - 繁體中文（zh-Hant）- 默認
    - English（en）
  - 使用方式：`String.localized(.keyName)` 或 `String.localized(.keyName, args:)`


- [x] **B-018**：加入登入/登出流程（F-017 + S-004）
  - 創建 AuthManager 認證管理器（Supabase Auth REST API）
    - Email OTP 流程：發送驗證碼 → 驗證登入
    - Email + 密碼流程：註冊 / 登入
    - Session 管理（本機持久化、Token 自動刷新）
    - 登出（通知服務端 + 清理本機 Session）
  - 創建 LoginView 登入頁面（S-004）
    - 支持兩種登入方式切換（OTP / 密碼）
    - OTP 模式：輸入 Email → 發送驗證碼 → 輸入驗證碼登入
    - 密碼模式：Email + 密碼登入/註冊切換
    - Cinematic Dark Void 風格，與主頁一致
    - 支援繁中/英文多語言
  - 修改 innerBloomApp.swift
    - App 啟動時判斷認證狀態（unknown / unauthenticated / authenticated）
    - unknown：顯示啟動畫面（Splash）
    - unauthenticated：顯示 LoginView（S-004）
    - authenticated：顯示 ContentView（S-001）
  - 設定頁加入「帳號」區塊
    - 顯示當前登入帳號 Email 與連線狀態
    - 登出按鈕 + 確認對話框
    - 登出時清理 HomeViewModel 數據（列表、標籤、草稿）
  - 添加 30+ 個本地化字符串（繁中/英文）覆蓋登入/登出全流程

- [x] **B-019**：資料庫多用戶隔離（F-018 + D-015/D-016）
  - DB：所有表（diaries、messages、tags、diary_tags）新增 `user_id` 欄位，引用 `auth.users(id)`
  - DB：新增效能索引（`user_id`、`user_id + created_at DESC`）支援 10 萬用戶快速查詢
  - DB：替換 RLS 策略為 `auth.uid() = user_id`（每張表 4 條策略：SELECT/INSERT/UPDATE/DELETE）
  - DB：tags 表唯一約束改為 `(user_id, name)`，不同使用者可擁有同名標籤
  - Storage：路徑格式改為 `{user_id}/images/{diaryId}.jpg`、`{user_id}/videos/{diaryId}.mp4`、`{user_id}/thumbnails/{diaryId}_thumb.jpg`
  - Storage：RLS 策略用 `storage.foldername(name)[1]` 驗證路徑歸屬，公開讀取保留
  - App - SupabaseDatabaseService：
    - 所有 HTTP 請求改用 user JWT（`AuthManager.getValidAccessToken()`）而非 anon key
    - 新增 `authenticatedRequest()` 統一建立帶認證的請求
    - DiaryAPIModel、MessageAPIModel、TagAPIModel 新增 `user_id` 欄位
    - 所有 INSERT/UPSERT 自動帶入 `currentUserId`
  - App - SupabaseStorageService：
    - 所有上傳/刪除請求改用 user JWT
    - 新增 `userPrefixedPath()` 自動為檔案路徑加上 `{user_id}/` 前綴
  - App - HomeViewModel：無需額外修改，RLS 自動過濾本人資料

- [x] **B-020**：10 萬用戶的基本穩定性加強（上線前必做）
  - 列表/搜尋一律分頁載入（每頁 20 條，支援無限滾動加載更多）
    - SupabaseDatabaseService: `getDiaries()` 默認 limit=20，`searchDiaries()` 新增 limit/offset 參數
    - HomeViewModel: 新增 `loadMoreDiaries()` + `onDiaryAppear()` 無限滾動觸發
    - DiaryListView: 新增 onEntryAppear 回調 + 加載更多指示器
  - 對常用查詢加索引（`user_id` + `created_at` 等）
    - 建立 `b020_indexes_migration.sql`：diaries、messages、tags、diary_tags 各表核心索引
  - 上傳與 AI 呼叫加入「重試 + 失敗回復」策略（避免尖峰時大量失敗）
    - 新增 `RetryHelper`：支援指數退避（Exponential Backoff）+ 可配置策略
    - 預設配置：database（3 次 1-2-4s）、upload（3 次 2-4-8s）、ai（2 次 3-6s）
    - SupabaseDatabaseService: `performRequest()` 自動重試（5xx/網絡錯誤）
    - SupabaseStorageService: `uploadFile()` 自動重試（含 token 刷新）
    - AIService: 所有後端/OpenAI 請求（analyze、chat、summary、tags）自動重試
  - 重要操作加上簡單的用量保護（例如同一使用者短時間大量請求要有提示/限制）
    - 新增 `RateLimiter`（actor，線程安全滑動窗口算法）
    - 陪伴對話：每 10s 最多 5 條 | 搜尋：每 5s 最多 3 次 | 保存：每 10s 最多 3 次
    - 被限流時顯示本地化提示（繁中/英文）
  - 新增多語言字符串：`rateLimitMessage`、`loadingMore`、`noMoreData`

- [ ] **B-021**：建立付費產品與方案讀取（F-021/F-022）
  - 在 App Store Connect 建立「自動續訂訂閱」：月付、年付（年付折扣），並配置 **3 天 Premium 試用**
  - App 端新增 IAPManager（使用 StoreKit 2）
    - 啟動時讀取產品列表（價格、試用文案）
    - 快取產品資訊供 S-005 顯示（D-019）

- [ ] **B-022**：付費牆 UI（S-005）與入口接線（F-021）
  - 新增 Premium 入口：
    - 設定頁「升級 Premium」
    - 觸發用量限制（S-006 → S-005）
  - S-005 顯示：權益、月/年方案、主要購買按鈕、Restore、條款/隱私

- [ ] **B-023**：完成購買 / 試用 / 續訂狀態同步（F-022 + D-017）
  - 購買成功後更新 Premium 狀態（本機快取）
  - App 啟動與回到前台時自動同步一次訂閱狀態
  - 若狀態不確定：先顯示「同步中」，同步完成再更新 UI

- [ ] **B-024**：恢復購買（Restore Purchases）（F-023）
  - S-005 增加「恢復購買」按鈕
  - 恢復成功後更新 Premium 狀態並提示「已恢復」

- [ ] **B-025**：把用量限制接到聊天與總結流程（F-020 + S-006 + D-018）
  - 對話互動上限（免費）：
    - 在 F-004 送出前檢查「本篇日記已互動次數」
    - 超過 4 次 → 顯示 S-006
    - Premium → 不限制（或上限提高）
  - 每日總結上限（免費）：
    - 在按下「結束保存」（F-005）前檢查今日是否已用完 1 次
    - 用完 → 顯示 S-006
    - Premium → 不限制（或上限提高）
  - 每日計數跨日自動重置（依本機日期）

- [ ] **B-026**：Premium 優先佇列（更快回覆）（F-024 + D-020）
  - App 端：所有陪伴請求（分析/聊天/總結/標籤）加上 `isPremium` 標記
  - 後端：收到 `isPremium=true` 時，排到較前面或給更高優先級
  - UI：Premium 可顯示小標「優先回覆中…」（可選）

- [ ] **B-027**：上線前檢查（不影響既有功能）
  - 確認「未付費」與「已付費」兩種狀態切換正確
  - 確認限制只擋到：聊天互動次數、每日總結；其它瀏覽/搜尋/回顧不受影響
  - App Store 文案與條款連結齊全（試用、續訂、取消方式說明）

- [ ] **B-028**：Premium 角色化陪伴（口吻風格）+ 總結跟隨角色（F-025/F-026 + D-021/D-022 + S-007）
  - 設定頁把「口吻風格」改成「陪伴角色」（不出現 AI 字樣）
  - S-007：用角色卡片（抽象符號風格 A）讓使用者選擇
  - 非 Premium：角色卡可看但不可選，點選 → 直接導去 S-005
  - Premium：切換角色立即生效
  - 更新後端提示詞組裝：
    - 聊天回覆（F-004）套用角色規則
    - 日記總結（F-005）也套用同一角色規則（讓整篇語氣一致）
